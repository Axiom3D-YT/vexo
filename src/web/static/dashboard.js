(function(){"use strict";var F,at;F={__e:function(e,t,n,i){for(var s,o,a;t=t.__;)if((s=t.__c)&&!s.__)try{if((o=s.constructor)&&o.getDerivedStateFromError!=null&&(s.setState(o.getDerivedStateFromError(e)),a=s.__d),s.componentDidCatch!=null&&(s.componentDidCatch(e,i||{}),a=s.__d),a)return s.__E=s}catch(r){e=r}throw e}},at=function(e){return e!=null&&e.constructor===void 0},typeof Promise=="function"&&Promise.prototype.then.bind(Promise.resolve());var Q,y,V,rt,lt=0,ct=[],f=F,dt=f.__b,ut=f.__r,ft=f.diffed,vt=f.__c,mt=f.unmount,gt=f.__;function Qt(e,t){f.__h&&f.__h(y,e,lt||t),lt=0;var n=y.__H||(y.__H={__:[],__h:[]});return e>=n.__.length&&n.__.push({}),n.__[e]}function pt(e,t){var n=Qt(Q++,7);return Yt(n.__H,t)&&(n.__=e(),n.__H=t,n.__h=e),n.__}function Vt(){for(var e;e=ct.shift();)if(e.__P&&e.__H)try{e.__H.__h.forEach(W),e.__H.__h.forEach(X),e.__H.__h=[]}catch(t){e.__H.__h=[],f.__e(t,e.__v)}}f.__b=function(e){y=null,dt&&dt(e)},f.__=function(e,t){e&&t.__k&&t.__k.__m&&(e.__m=t.__k.__m),gt&&gt(e,t)},f.__r=function(e){ut&&ut(e),Q=0;var t=(y=e.__c).__H;t&&(V===y?(t.__h=[],y.__h=[],t.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(t.__h.forEach(W),t.__h.forEach(X),t.__h=[],Q=0)),V=y},f.diffed=function(e){ft&&ft(e);var t=e.__c;t&&t.__H&&(t.__H.__h.length&&(ct.push(t)!==1&&rt===f.requestAnimationFrame||((rt=f.requestAnimationFrame)||Xt)(Vt)),t.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),V=y=null},f.__c=function(e,t){t.some(function(n){try{n.__h.forEach(W),n.__h=n.__h.filter(function(i){return!i.__||X(i)})}catch(i){t.some(function(s){s.__h&&(s.__h=[])}),t=[],f.__e(i,n.__v)}}),vt&&vt(e,t)},f.unmount=function(e){mt&&mt(e);var t,n=e.__c;n&&n.__H&&(n.__H.__.forEach(function(i){try{W(i)}catch(s){t=s}}),n.__H=void 0,t&&f.__e(t,n.__v))};var yt=typeof requestAnimationFrame=="function";function Xt(e){var t,n=function(){clearTimeout(i),yt&&cancelAnimationFrame(t),setTimeout(e)},i=setTimeout(n,35);yt&&(t=requestAnimationFrame(n))}function W(e){var t=y,n=e.__c;typeof n=="function"&&(e.__c=void 0,n()),y=t}function X(e){var t=y;e.__c=e.__(),y=t}function Yt(e,t){return!e||e.length!==t.length||t.some(function(n,i){return n!==e[i]})}var Kt=Symbol.for("preact-signals");function Y(){if(C>1)C--;else{for(var e,t=!1;D!==void 0;){var n=D;for(D=void 0,K++;n!==void 0;){var i=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&bt(n))try{n.c()}catch(s){t||(e=s,t=!0)}n=i}}if(K=0,C--,t)throw e}}var l=void 0;function ht(e){var t=l;l=void 0;try{return e()}finally{l=t}}var D=void 0,C=0,K=0,z=0;function _t(e){if(l!==void 0){var t=e.n;if(t===void 0||t.t!==l)return t={i:0,S:e,p:l.s,n:void 0,t:l,e:void 0,x:void 0,r:t},l.s!==void 0&&(l.s.n=t),l.s=t,e.n=t,32&l.f&&e.S(t),t;if(t.i===-1)return t.i=0,t.n!==void 0&&(t.n.p=t.p,t.p!==void 0&&(t.p.n=t.n),t.p=l.s,t.n=void 0,l.s.n=t,l.s=t),t}}function m(e,t){this.v=e,this.i=0,this.n=void 0,this.t=void 0,this.W=t==null?void 0:t.watched,this.Z=t==null?void 0:t.unwatched,this.name=t==null?void 0:t.name}m.prototype.brand=Kt,m.prototype.h=function(){return!0},m.prototype.S=function(e){var t=this,n=this.t;n!==e&&e.e===void 0&&(e.x=n,this.t=e,n!==void 0?n.e=e:ht(function(){var i;(i=t.W)==null||i.call(t)}))},m.prototype.U=function(e){var t=this;if(this.t!==void 0){var n=e.e,i=e.x;n!==void 0&&(n.x=i,e.e=void 0),i!==void 0&&(i.e=n,e.x=void 0),e===this.t&&(this.t=i,i===void 0&&ht(function(){var s;(s=t.Z)==null||s.call(t)}))}},m.prototype.subscribe=function(e){var t=this;return x(function(){var n=t.value,i=l;l=void 0;try{e(n)}finally{l=i}},{name:"sub"})},m.prototype.valueOf=function(){return this.value},m.prototype.toString=function(){return this.value+""},m.prototype.toJSON=function(){return this.value},m.prototype.peek=function(){var e=l;l=void 0;try{return this.value}finally{l=e}},Object.defineProperty(m.prototype,"value",{get:function(){var e=_t(this);return e!==void 0&&(e.i=this.i),this.v},set:function(e){if(e!==this.v){if(K>100)throw new Error("Cycle detected");this.v=e,this.i++,z++,C++;try{for(var t=this.t;t!==void 0;t=t.x)t.t.N()}finally{Y()}}}});function E(e,t){return new m(e,t)}function bt(e){for(var t=e.s;t!==void 0;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function wt(e){for(var t=e.s;t!==void 0;t=t.n){var n=t.S.n;if(n!==void 0&&(t.r=n),t.S.n=t,t.i=-1,t.n===void 0){e.s=t;break}}}function Et(e){for(var t=e.s,n=void 0;t!==void 0;){var i=t.p;t.i===-1?(t.S.U(t),i!==void 0&&(i.n=t.n),t.n!==void 0&&(t.n.p=i)):n=t,t.S.n=t.r,t.r!==void 0&&(t.r=void 0),t=i}e.s=n}function S(e,t){m.call(this,void 0),this.x=e,this.s=void 0,this.g=z-1,this.f=4,this.W=t==null?void 0:t.watched,this.Z=t==null?void 0:t.unwatched,this.name=t==null?void 0:t.name}S.prototype=new m,S.prototype.h=function(){if(this.f&=-3,1&this.f)return!1;if((36&this.f)==32||(this.f&=-5,this.g===z))return!0;if(this.g=z,this.f|=1,this.i>0&&!bt(this))return this.f&=-2,!0;var e=l;try{wt(this),l=this;var t=this.x();(16&this.f||this.v!==t||this.i===0)&&(this.v=t,this.f&=-17,this.i++)}catch(n){this.v=n,this.f|=16,this.i++}return l=e,Et(this),this.f&=-2,!0},S.prototype.S=function(e){if(this.t===void 0){this.f|=36;for(var t=this.s;t!==void 0;t=t.n)t.S.S(t)}m.prototype.S.call(this,e)},S.prototype.U=function(e){if(this.t!==void 0&&(m.prototype.U.call(this,e),this.t===void 0)){this.f&=-33;for(var t=this.s;t!==void 0;t=t.n)t.S.U(t)}},S.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var e=this.t;e!==void 0;e=e.x)e.t.N()}},Object.defineProperty(S.prototype,"value",{get:function(){if(1&this.f)throw new Error("Cycle detected");var e=_t(this);if(this.h(),e!==void 0&&(e.i=this.i),16&this.f)throw this.v;return this.v}});function te(e,t){return new S(e,t)}function $t(e){var t=e.u;if(e.u=void 0,typeof t=="function"){C++;var n=l;l=void 0;try{t()}catch(i){throw e.f&=-2,e.f|=8,tt(e),i}finally{l=n,Y()}}}function tt(e){for(var t=e.s;t!==void 0;t=t.n)t.S.U(t);e.x=void 0,e.s=void 0,$t(e)}function ee(e){if(l!==this)throw new Error("Out-of-order effect");Et(this),l=e,this.f&=-2,8&this.f&&tt(this),Y()}function L(e,t){this.x=e,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32,this.name=t==null?void 0:t.name}L.prototype.c=function(){var e=this.S();try{if(8&this.f||this.x===void 0)return;var t=this.x();typeof t=="function"&&(this.u=t)}finally{e()}},L.prototype.S=function(){if(1&this.f)throw new Error("Cycle detected");this.f|=1,this.f&=-9,$t(this),wt(this),C++;var e=l;return l=this,ee.bind(this,e)},L.prototype.N=function(){2&this.f||(this.f|=2,this.o=D,D=this)},L.prototype.d=function(){this.f|=8,1&this.f||tt(this)},L.prototype.dispose=function(){this.d()};function x(e,t){var n=new L(e,t);try{n.c()}catch(s){throw n.d(),s}var i=n.d.bind(n);return i[Symbol.dispose]=i,i}var R;function T(e,t){F[e]=t.bind(null,F[e]||function(){})}function J(e){if(R){var t=R;R=void 0,t()}R=e&&e.S()}function It(e){var t=this,n=e.data,i=ie(n);i.value=n;var s=pt(function(){for(var o=t.__v;o=o.__;)if(o.__c){o.__c.__$f|=4;break}return t.__$u.c=function(){var a,r=t.__$u.S(),v=s.value;r(),at(v)||((a=t.base)==null?void 0:a.nodeType)!==3?(t.__$f|=1,t.setState({})):t.base.data=v},te(function(){var a=i.value.value;return a===0?0:a===!0?"":a||""})},[]);return s.value}It.displayName="_st",Object.defineProperties(m.prototype,{constructor:{configurable:!0,value:void 0},type:{configurable:!0,value:It},props:{configurable:!0,get:function(){return{data:this}}},__b:{configurable:!0,value:1}}),T("__b",function(e,t){if(typeof t.type=="string"){var n,i=t.props;for(var s in i)if(s!=="children"){var o=i[s];o instanceof m&&(n||(t.__np=n={}),n[s]=o,i[s]=o.peek())}}e(t)}),T("__r",function(e,t){e(t),J();var n,i=t.__c;i&&(i.__$f&=-2,(n=i.__$u)===void 0&&(i.__$u=n=function(s){var o;return x(function(){o=this}),o.c=function(){i.__$f|=1,i.setState({})},o}())),J(n)}),T("__e",function(e,t,n,i){J(),e(t,n,i)}),T("diffed",function(e,t){J();var n;if(typeof t.type=="string"&&(n=t.__e)){var i=t.__np,s=t.props;if(i){var o=n.U;if(o)for(var a in o){var r=o[a];r!==void 0&&!(a in i)&&(r.d(),o[a]=void 0)}else n.U=o={};for(var v in i){var g=o[v],h=i[v];g===void 0?(g=ne(n,v,h,s),o[v]=g):g.o(h,s)}}}e(t)});function ne(e,t,n,i){var s=t in e&&e.ownerSVGElement===void 0,o=E(n);return{o:function(a,r){o.value=a,i=r},d:x(function(){var a=o.value.value;i[t]!==a&&(i[t]=a,s?e[t]=a:a?e.setAttribute(t,a):e.removeAttribute(t))})}}T("unmount",function(e,t){if(typeof t.type=="string"){var n=t.__e;if(n){var i=n.U;if(i){n.U=void 0;for(var s in i){var o=i[s];o&&o.d()}}}}else{var a=t.__c;if(a){var r=a.__$u;r&&(a.__$u=void 0,r.d())}}e(t)}),T("__h",function(e,t,n,i){(i<3||i===9)&&(t.__$f|=2),e(t,n,i)});function ie(e){return pt(function(){return E(e)},[])}const p={status:"/api/status",guilds:"/api/guilds",guild:e=>`/api/guilds/${e}`,settings:e=>`/api/guilds/${e}/settings`,analytics:"/api/analytics",users:"/api/users",songs:"/api/songs",library:"/api/library",topSongs:"/api/analytics/top-songs",userPrefs:e=>`/api/users/${e}/preferences`,notifications:"/api/notifications",settings_global:"/api/settings/global",leave_guild:e=>`/api/guilds/${e}/leave`},$=E(null),c=E("global"),q=E([]),P=E(1),et=50,nt=E({status:"offline"}),se=E([]);x(()=>{At(),Dt()}),x(()=>{c.value!=="global"&&st()}),x(()=>{Lt(nt.value)}),x(()=>{qt()}),document.addEventListener("DOMContentLoaded",()=>{St(),Bt(),st(),Dt(),de(),setInterval(Ct,5e3),setInterval(it,1e4),setInterval(At,15e3),setInterval(st,3e4),setInterval(he,15e3),document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),Z(e.dataset.tab)})})});let B=null,kt=new Set;function St(){try{const t=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/logs`;console.log(`[Dashboard] Connecting to WebSocket: ${t}`),B=new WebSocket(t),B.onopen=()=>{console.log("[Dashboard] WebSocket connected")},B.onmessage=n=>{const i=JSON.parse(n.data);xt(i)},B.onclose=n=>{console.warn("[Dashboard] WebSocket closed, retrying in 3s...",n.reason),setTimeout(St,3e3)},B.onerror=n=>console.error("[Dashboard] WebSocket error:",n)}catch(e){console.error("[Dashboard] WS Init Error",e)}}setInterval(async()=>{if(!B||B.readyState!==WebSocket.OPEN)try{const e=await fetch("/api/logs");if(e.ok){const t=await e.json();t.logs&&t.logs.forEach(n=>xt(n))}}catch(e){console.error("[Dashboard] Polling failed",e)}},1e4);function xt(e){const t=document.getElementById("logs");if(!t)return;const n=`${e.timestamp}-${e.level}-${e.message.substring(0,50)}`;if(kt.has(n))return;kt.add(n);const i=new Date(e.timestamp*1e3).toLocaleTimeString(),s=document.createElement("div");for(s.className=`log-entry log-${e.level}`,s.innerHTML=`<span class="log-time">${i}</span> [${e.level}] ${e.message}`,t.appendChild(s),t.scrollTop=t.scrollHeight;t.children.length>500;)t.removeChild(t.firstChild)}async function Bt(){oe();try{const t=await(await fetch("/api/dashboard-init")).json();if(t.status&&Lt(t.status),t.guilds&&(Tt(t.guilds),c.value!=="global")){const n=t.guilds.find(i=>i.id===c.value);if(n){const i=document.getElementById("server-stat-members");i&&(i.textContent=n.member_count||0);const s=document.getElementById("server-stat-queue");s&&(s.textContent=n.queue_size||0);const o=document.getElementById("server-stat-duration");o&&(o.textContent=`${n.queue_duration||0}m`)}}Pt(t.guilds),Ht(t.guilds),Mt(t.analytics),se.value=t.notifications,Ut(t.notifications),!$.value&&t.guilds.length>0&&($.value=t.guilds[0].id),jt(t.analytics)}catch(e){console.error("Init failed",e)}}function oe(){const e=document.getElementById("now-playing");e&&(e.innerHTML=`
        <div class="np-content">
            <div class="skeleton skeleton-artwork"></div>
            <div class="np-info">
                <div class="skeleton skeleton-text" style="width: 60%"></div>
                <div class="skeleton skeleton-text" style="width: 40%"></div>
                <div class="skeleton skeleton-text" style="width: 80%; height: 2rem; margin-top: 1rem;"></div>
            </div>
        </div>
    `),document.querySelectorAll(".stat-value").forEach(n=>n.innerHTML='<span class="skeleton skeleton-text" style="width: 40px; height: 2rem;"></span>')}async function Ct(){try{const t=await(await fetch(p.status)).json();nt.value=t}catch(e){console.error("Failed to fetch status",e);try{nt.value={status:"offline"}}catch{}}}function Lt(e){try{const t=document.querySelector(".status-dot"),n=document.getElementById("status-text"),i=document.getElementById("stat-guilds"),s=document.getElementById("stat-voice"),o=document.getElementById("stat-latency-val"),a=document.getElementById("stat-latency"),r=document.getElementById("stat-cpu"),v=document.getElementById("stat-ram");t&&(t.className=`status-dot status-${e.status==="online"?"online":"offline"}`),n&&(n.textContent=e.status==="online"?`Online (${e.latency_ms||0}ms)`:"Offline"),i&&(i.textContent=e.guilds||0),s&&(s.textContent=e.voice_connections||0),o&&(o.textContent=`${e.latency_ms||0}ms`),a&&(a.textContent=`${e.latency_ms||0}ms`),r&&(r.textContent=e.cpu_percent||0),v&&(v.textContent=e.ram_percent||0);const g=document.getElementById("stat-uptime");g&&(g.textContent=Gt(e.uptime_seconds))}catch(t){console.error("Error updating status",t)}}async function it(){try{const t=await(await fetch(p.guilds)).json();if(!$.value&&t.guilds&&t.guilds.length>0&&($.value=t.guilds[0].id),Tt(t.guilds||[]),Pt(t.guilds||[]),Ht(t.guilds||[]),c.value!=="global"&&t.guilds){const n=t.guilds.find(i=>i.id===c.value);if(n){const i=document.getElementById("server-stat-members");i&&(i.textContent=n.member_count||0);const s=document.getElementById("server-stat-queue");s&&(s.textContent=n.queue_size||0);const o=document.getElementById("server-stat-duration");o&&(o.textContent=`${n.queue_duration||0}m`)}}}catch(e){console.error("Failed to fetch guilds",e)}}function Tt(e){const t=document.getElementById("server-nav");if(!t)return;let n=`<div class="server-nav-item ${c.value==="global"?"active":""}" onclick="switchScope('global')">Global</div>`;n+=e.map(i=>`
        <div class="server-nav-item ${c.value===i.id?"active":""}" onclick="switchScope('${i.id}')">
            ${i.name||"Server"}
            ${i.is_playing?" üîä":""}
        </div>
    `).join(""),t.innerHTML=n}function Pt(e){const t=document.getElementById("guild-list");t&&(t.innerHTML=e.map(n=>`
        <div class="user-item ${n.id===$.value?"active":""}" onclick="selectGuild(event, '${n.id}')">
            <div class="user-avatar">${(n.name||"?").charAt(0)}</div>
            <div class="user-info">
                <div class="user-name">${n.name||"Unknown Server"}</div>
                <div class="user-stats">${n.member_count||0} members</div>
            </div>
            <div class="user-actions" style="display: flex; gap: 0.5rem; align-items: center;">
                ${n.is_playing?'<span style="color: var(--success); font-size: 0.8rem;">‚ñ∂ Playing</span>':""}
                <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;" onclick="event.stopPropagation(); leaveGuild('${n.id}')">Leave</button>
            </div>
        </div>
    `).join(""))}async function ae(e){if(confirm("Are you sure you want the bot to leave this server?"))try{(await fetch(p.leave_guild(e),{method:"POST"})).ok?it():alert("Failed to leave server")}catch(t){console.error(t),alert("Error leaving server")}}async function re(){if(!c.value||c.value==="global")return;const e=c.value;if(confirm("Are you sure you want the bot to leave this server? This action is permanent!"))try{(await fetch(p.leave_guild(e),{method:"POST"})).ok?(alert("Bot has left the server."),ot("global"),Bt()):alert("Failed to leave server")}catch(t){console.error(t),alert("Error leaving server")}}function Ht(e){const t=document.getElementById("now-playing");if(!t)return;let n=null;if(c.value==="global"?n=e.find(i=>i.is_playing&&i.current_song):n=e.find(i=>i.id===c.value&&i.is_playing&&i.current_song),n){let i="";if(n.duration_seconds){const s=Math.floor(n.duration_seconds/60),o=n.duration_seconds%60;i=`${s}:${o.toString().padStart(2,"0")}`}t.innerHTML=`
            <div class="np-content">
                <img class="np-artwork" src="https://img.youtube.com/vi/${n.video_id||"dQw4w9WgXcQ"}/hqdefault.jpg" alt="Album art">
                <div class="np-info">
                    <div class="np-title">${n.current_song||"Unknown"}</div>
                    <div class="np-artist">${n.current_artist||"Unknown Artist"}</div>
                    <div class="np-metadata">
                        ${i?`<span>‚è≥ ${i}</span>`:""}
                        ${n.genre?`<span>üè∑Ô∏è ${n.genre}</span>`:""}
                        ${n.year?`<span>üìÖ ${n.year}</span>`:""}
                    </div>
                    ${n.discovery_reason?`<div class="np-discovery">${n.discovery_reason}</div>`:""}
                    <div class="np-controls">
                        <button class="np-btn" onclick="control('pause')">‚è∏Ô∏è</button>
                        <button class="np-btn" onclick="control('skip')">‚è≠Ô∏è</button>
                        <button class="np-btn" onclick="control('stop')">‚èπÔ∏è</button>
                    </div>
                </div>
            </div>
        `,t.style.display="block"}else t.innerHTML='<div class="np-content" style="justify-content: center;"><span style="color: var(--text-muted);">Nothing playing</span></div>'}async function At(){try{let e=p.analytics;c.value!=="global"&&(e+=`?guild_id=${c.value}`);const n=await(await fetch(e)).json();Mt(n)}catch(e){console.error("Failed to fetch analytics",e)}}function Mt(e){var t,n,i,s,o,a,r,v,g;try{const h=document.getElementById("stat-songs"),U=document.getElementById("stat-users"),G=document.getElementById("stat-plays");G&&(G.textContent=e.total_plays||0);const I=document.getElementById("stat-uptime");I&&e.uptime_seconds&&(I.textContent=Gt(e.uptime_seconds)),h&&(h.textContent=e.total_songs||0),U&&(U.textContent=e.total_users||0);const _=document.getElementById("stat-songs-global");_&&(_.textContent=e.total_songs||0);const k=document.getElementById("stat-plays-global");k&&(k.textContent=e.total_plays||0);const b=document.getElementById("stat-users-global");b&&(b.textContent=e.total_users||0);const w=document.getElementById("top-songs-table");w&&(!e.top_songs||e.top_songs.length===0?w.innerHTML='<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 2rem;">No songs played yet</td></tr>':w.innerHTML=e.top_songs.slice(0,10).map((u,j)=>`
                    <tr>
                        <td>${j+1}</td>
                        <td>
                            <div class="song-cell">
                                <img class="song-thumb" src="https://img.youtube.com/vi/${u.yt_id}/default.jpg" alt="">
                                <div class="song-info">
                                    <span class="song-name">${u.title}</span>
                                    <span class="song-artist">${u.artist}</span>
                                </div>
                            </div>
                        </td>
                        <td>${u.plays}</td>
                        <td>${u.likes} ‚ù§Ô∏è</td>
                    </tr>
                `).join(""));const H=document.getElementById("top-users-list");H&&(!e.top_users||e.top_users.length===0?H.innerHTML='<div style="text-align: center; color: var(--text-muted); padding: 1rem;">No users active yet</div>':H.innerHTML=e.top_users.slice(0,10).map(u=>`
                    <div class="user-item" onclick="viewUser('${u.id}')">
                        <div class="user-avatar">${(u.name||"?").charAt(0)}</div>
                        <div class="user-info">
                            <div class="user-name">${u.name||"Unknown"}</div>
                            <div class="user-stats">${u.plays||0} plays ‚Ä¢ ${u.total_likes||0} likes</div>
                        </div>
                    </div>
                `).join(""));const A={"insight-liked-genre":(n=(t=e.top_liked_genres)==null?void 0:t[0])==null?void 0:n.name,"insight-liked-artist":(s=(i=e.top_liked_artists)==null?void 0:i[0])==null?void 0:s.name,"insight-liked-song":(o=e.top_liked_songs)!=null&&o[0]?`${e.top_liked_songs[0].title} by ${e.top_liked_songs[0].artist}`:null,"insight-played-genre":(r=(a=e.top_played_genres)==null?void 0:a[0])==null?void 0:r.name,"insight-played-artist":(g=(v=e.top_played_artists)==null?void 0:v[0])==null?void 0:g.name};for(const[u,j]of Object.entries(A)){const O=document.getElementById(u);O&&(O.textContent=j||"-")}const M=document.getElementById("useful-users-list");M&&(!e.top_useful_users||e.top_useful_users.length===0?M.innerHTML='<div style="text-align: center; color: var(--text-muted); padding: 1rem;">No useful activity yet</div>':M.innerHTML=e.top_useful_users.map(u=>`
                    <div class="user-item">
                        <div class="user-avatar" style="background: var(--gradient-2)">${(u.username||"?").charAt(0)}</div>
                        <div class="user-info">
                            <div class="user-name">${u.username||"Unknown"}</div>
                            <div class="user-stats">${u.score||0} helpfulness points</div>
                        </div>
                    </div>
                `).join("")),Nt(e),c.value!=="global"&&le(e)}catch(h){console.error("Error updating analytics",h)}}let d={};function jt(e){if(!window.Chart)return;const t={primary:"#8b5cf6",secondary:"#ec4899",tertiary:"#06b6d4",text:"#64748b"},n=document.getElementById("plays-chart");n&&(d.plays&&d.plays.destroy(),d.plays=new Chart(n,{type:"line",data:{labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],datasets:[{label:"Plays",data:e.playback_trends||[10,25,15,30,45,20,35],borderColor:t.primary,backgroundColor:"rgba(139, 92, 246, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{grid:{color:"rgba(255,255,255,0.05)"},ticks:{color:t.text}},x:{grid:{display:!1},ticks:{color:t.text}}}}}));const i=document.getElementById("genres-chart");if(i){d.genres&&d.genres.destroy();const a=(e.top_played_genres||[]).slice(0,5);d.genres=new Chart(i,{type:"doughnut",data:{labels:a.map(r=>r.name||"Unknown"),datasets:[{data:a.map(r=>r.plays||0),backgroundColor:[t.primary,t.secondary,t.tertiary,"#f59e0b","#10b981"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{color:t.text,padding:20}}}}})}const s=document.getElementById("server-plays-chart");s&&(d.serverPlays&&d.serverPlays.destroy(),d.serverPlays=new Chart(s,{type:"line",data:{labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],datasets:[{label:"Server Plays",data:e.playback_trends||[0,0,0,0,0,0,0],borderColor:t.secondary,backgroundColor:"rgba(236, 72, 153, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{grid:{color:"rgba(255,255,255,0.05)"},ticks:{color:t.text}},x:{grid:{display:!1},ticks:{color:t.text}}}}}));const o=document.getElementById("peak-chart");o&&(d.peak&&d.peak.destroy(),d.peak=new Chart(o,{type:"bar",data:{labels:Array.from({length:24},(a,r)=>`${r}h`),datasets:[{label:"Plays",data:e.peak_hours||Array(24).fill(0),backgroundColor:t.tertiary,borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{grid:{color:"rgba(255,255,255,0.05)"},ticks:{color:t.text}},x:{grid:{display:!1},ticks:{color:t.text,font:{size:9}}}}}}))}function Nt(e){if(e){if(d.plays&&e.playback_trends&&(d.plays.data.datasets[0].data=e.playback_trends,d.plays.update()),d.genres&&e.top_played_genres){const t=e.top_played_genres.slice(0,5);d.genres.data.labels=t.map(n=>n.name),d.genres.data.datasets[0].data=t.map(n=>n.plays),d.genres.update()}d.peak&&e.peak_hours&&(d.peak.data.datasets[0].data=e.peak_hours,d.peak.update())}}function le(e){d.serverPlays&&e.playback_trends&&(d.serverPlays.data.datasets[0].data=e.playback_trends,d.serverPlays.update())}async function st(){try{let e=p.songs;c.value!=="global"&&(e+=`?guild_id=${c.value}`);const n=await(await fetch(e)).json();ce(n.songs||[])}catch(e){console.error(e)}}function ce(e){const t=document.getElementById("songs-list");if(t){if(e.length===0){t.innerHTML='<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No songs found</td></tr>';return}t.innerHTML=e.map(n=>{let i="-";if(n.duration_seconds){const o=Math.floor(n.duration_seconds/60),a=n.duration_seconds%60;i=`${o}:${a.toString().padStart(2,"0")}`}let s=n.played_at?new Date(n.played_at).toLocaleString():"Never";return`
            <tr>
                <td>${n.title}</td>
                <td>${n.artist_name}</td>
                <td>${i}</td>
                <td>${n.genre||"-"}</td>
                <td><span class="user-list">${n.requested_by||"-"}</span></td>
                <td><span class="user-list liked">${n.liked_by||"-"}</span></td>
                <td><span class="user-list disliked">${n.disliked_by||"-"}</span></td>
                <td>${s}</td>
            </tr>
        `}).join("")}}async function de(){try{let e=p.users;c.value!=="global"&&(e+=`?guild_id=${c.value}`);const n=await(await fetch(e)).json();ue(n.users||[])}catch(e){console.error(e)}}function ue(e){const t=document.getElementById("users-directory");if(t){if(e.length===0){t.innerHTML='<div style="text-align: center; color: var(--text-muted);">No users found</div>';return}t.innerHTML=e.map(n=>`
        <div class="user-item">
            <div class="user-avatar">${(n.username||"?").charAt(0)}</div>
            <div class="user-info">
                <div class="user-name">${n.username||"Unknown"}</div>
                <div class="user-stats">${n.formatted_id||n.discord_id||"ID: "+n.id}</div>
            </div>
            <div class="user-metrics" style="margin-left: auto; text-align: right; font-size: 0.8rem; color: var(--text-muted);">
                <div>${n.reactions||0} reactions</div>
                <div>${n.playlists||0} playlists</div>
            </div>
        </div>
    `).join("")}}async function Dt(){try{let e=p.library;c.value!=="global"&&(e+=`?guild_id=${c.value}`);const n=await(await fetch(e)).json();q.value=n.library||[],P.value=1,qt()}catch(e){console.error(e)}}function qt(){const e=document.getElementById("library-list"),t=document.getElementById("library-pagination");if(!e||!t)return;if(q.value.length===0){e.innerHTML='<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Library is empty</td></tr>',t.innerHTML="";return}const n=(P.value-1)*et,i=n+et,s=q.value.slice(n,i);e.innerHTML=s.map(a=>{let r=a.last_added?new Date(a.last_added).toLocaleDateString():"-";const v={request:"üì® Request",like:"‚ù§Ô∏è Like",import:"üì• Import"},g=(a.sources||"").split(",").map(h=>v[h]||h).join(", ");return`
            <tr>
                <td>${a.title}</td>
                <td>${a.artist_name}</td>
                <td>${a.genre||"-"}</td>
                <td>${g}</td>
                <td><span class="user-list">${a.contributors||"-"}</span></td>
                <td>${r}</td>
            </tr>
        `}).join("");const o=Math.ceil(q.value.length/et);t.innerHTML=`
        <button class="page-btn" ${P.value===1?"disabled":""} onclick="changeLibraryPage(-1)">Previous</button>
        <span class="page-info">Page ${P.value} of ${o} (${q.value.length} items)</span>
        <button class="page-btn" ${P.value===o?"disabled":""} onclick="changeLibraryPage(1)">Next</button>
    `}function fe(e){P.value+=e,document.getElementById("library-table").scrollIntoView({behavior:"smooth",block:"start"})}function ve(e,t){$.value=t,document.querySelectorAll(".user-item").forEach(n=>n.classList.remove("active")),e&&e.currentTarget&&e.currentTarget.classList.add("active")}function me(e){console.log("View user",e)}function ge(e){$.value&&fetch(`/api/guilds/${$.value}/control/${e}`,{method:"POST"}).then(()=>setTimeout(it,200))}function Z(e){document.querySelectorAll(".tab").forEach(i=>i.classList.remove("active"));const t=document.querySelector(`[data-tab="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".tab-content").forEach(i=>i.style.display="none");const n=document.getElementById(`tab-${e}`);n&&(n.style.display="block"),e==="settings"&&ye()}async function ot(e,t="dashboard"){if(c.value=e,e==="global"?(document.body.classList.remove("view-server"),document.body.classList.add("view-global")):(document.body.classList.remove("view-global"),document.body.classList.add("view-server")),document.querySelectorAll(".server-nav-item").forEach(n=>{var i;n.classList.remove("active"),e==="global"&&n.textContent.includes("Global")&&n.classList.add("active"),(i=n.getAttribute("onclick"))!=null&&i.includes(`'${e}'`)&&n.classList.add("active")}),e==="global"){Ct(),Z(t);const n=document.getElementById("stat-guilds");n&&(n.nextElementSibling.textContent="Servers")}else try{const i=await(await fetch(p.guild(e))).json(),s=document.getElementById("stat-guilds");s&&(s.textContent=i.queue_size||0,s.nextElementSibling.textContent="In Queue"),Z(t)}catch(n){console.error(e,n)}}function pe(){ot("global","settings")}async function ye(){var i,s,o,a,r,v,g,h,U,G;const e=document.getElementById("settings-title"),t=document.getElementById("settings-global"),n=document.getElementById("settings-server");if(c.value==="global"){e&&(e.textContent="‚öôÔ∏è Global Settings"),t&&(t.style.display="block"),n&&(n.style.display="none");try{const _=await(await fetch(p.settings_global)).json(),k=document.getElementById("setting-max-servers-tab");k&&(k.value=_.max_concurrent_servers||"");const b=document.getElementById("setting-test-mode");b&&(b.checked=!!_.test_mode);const w=document.getElementById("setting-test-duration");w&&(w.value=_.playback_duration||30)}catch(I){console.error(I)}}else{e&&(e.textContent="‚öôÔ∏è Server Settings"),t&&(t.style.display="none"),n&&(n.style.display="block");try{const _=await(await fetch(p.settings(c.value))).json(),k=document.getElementById("setting-pre-buffer");k&&(k.checked=!!_.pre_buffer);const b=document.getElementById("setting-buffer-amount");if(b){b.value=_.buffer_amount||1;const Zt=document.getElementById("buffer-val");Zt&&(Zt.textContent=b.value)}const w=document.getElementById("setting-max-duration");w&&(w.value=_.max_song_duration||6);const H=document.getElementById("setting-ephemeral-duration");H&&(H.value=_.ephemeral_duration||10);const A=_.discovery_weights||{similar:25,artist:25,wildcard:25,library:25},M=document.getElementById("weight-similar");M&&(M.value=A.similar||0);const u=document.getElementById("weight-artist");u&&(u.value=A.artist||0);const j=document.getElementById("weight-wildcard");j&&(j.value=A.wildcard||0);const O=document.getElementById("weight-library");O&&(O.value=A.library||0),Ee();const N=_.metadata_config||{strategy:"fallback",engines:{spotify:{enabled:!0,priority:1},discogs:{enabled:!0,priority:2},musicbrainz:{enabled:!0,priority:3}}},Ot=document.getElementById("meta-strategy");Ot&&(Ot.value=N.strategy||"fallback");const Ft=document.getElementById("meta-discogs-enabled");Ft&&(Ft.checked=((s=(i=N.engines)==null?void 0:i.discogs)==null?void 0:s.enabled)!==!1);const Wt=document.getElementById("meta-discogs-prio");Wt&&(Wt.value=((a=(o=N.engines)==null?void 0:o.discogs)==null?void 0:a.priority)||2);const zt=document.getElementById("meta-mb-enabled");zt&&(zt.checked=((v=(r=N.engines)==null?void 0:r.musicbrainz)==null?void 0:v.enabled)!==!1);const Rt=document.getElementById("meta-mb-prio");Rt&&(Rt.value=((h=(g=N.engines)==null?void 0:g.musicbrainz)==null?void 0:h.priority)||3);const Jt=document.getElementById("meta-spotify-prio");Jt&&(Jt.value=((G=(U=N.engines)==null?void 0:U.spotify)==null?void 0:G.priority)||1)}catch(I){console.error(I)}}}async function he(){try{const t=await(await fetch(p.notifications)).json();Ut(t.notifications||[])}catch(e){console.error(e)}}function Ut(e){const t=document.getElementById("notif-list"),n=document.getElementById("notif-dot");if(t){if(e.length===0){t.innerHTML='<div class="notif-item" style="color: var(--text-muted); text-align: center;">No new notifications</div>',n&&(n.style.display="none");return}n&&(n.style.display="block"),t.innerHTML=e.map(i=>`
        <div class="notif-item">
            <div style="font-weight: 500; color: var(--${i.level==="error"?"error":i.level==="warning"?"warning":"text-primary"})">${i.level.toUpperCase()}</div>
            <div>${i.message}</div>
            <div class="notif-time">${new Date(i.created_at*1e3).toLocaleString()}</div>
        </div>
    `).join("")}}function _e(){dd&&dd.classList.toggle("show")}async function be(){if(!c.value||c.value==="global")return;const e=c.value,t=document.getElementById("setting-pre-buffer").checked,n=document.getElementById("setting-buffer-amount").value,i=document.getElementById("setting-max-duration").value,s=document.getElementById("setting-ephemeral-duration").value,o={similar:parseInt(document.getElementById("weight-similar").value)||0,artist:parseInt(document.getElementById("weight-artist").value)||0,wildcard:parseInt(document.getElementById("weight-wildcard").value)||0,library:parseInt(document.getElementById("weight-library").value)||0},a={strategy:document.getElementById("meta-strategy").value,engines:{spotify:{enabled:!0,priority:parseInt(document.getElementById("meta-spotify-prio").value)||1},discogs:{enabled:document.getElementById("meta-discogs-enabled").checked,priority:parseInt(document.getElementById("meta-discogs-prio").value)||2},musicbrainz:{enabled:document.getElementById("meta-mb-enabled").checked,priority:parseInt(document.getElementById("meta-mb-prio").value)||3}}};try{(await fetch(p.settings(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pre_buffer:t,buffer_amount:parseInt(n),max_song_duration:parseInt(i),ephemeral_duration:parseInt(s),discovery_weights:o,metadata_config:a})})).ok?alert("Settings saved!"):alert("Failed to save settings")}catch(r){console.error(r),alert("Error saving settings")}}async function we(){const e=document.getElementById("setting-max-servers-tab").value,t=document.getElementById("setting-test-mode").checked,n=document.getElementById("setting-test-duration").value;try{(await fetch(p.settings_global,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({max_concurrent_servers:e?parseInt(e):null,test_mode:t,playback_duration:n?parseInt(n):30})})).ok?alert("Global settings saved!"):alert("Failed to save global settings")}catch(i){console.error(i),alert("Error saving global settings")}}function Ee(){const e=parseInt(document.getElementById("weight-similar").value)||0,t=parseInt(document.getElementById("weight-artist").value)||0,n=parseInt(document.getElementById("weight-wildcard").value)||0,i=parseInt(document.getElementById("weight-library").value)||0,s=e+t+n+i,o=document.getElementById("weights-total");o&&(o.textContent=s,o.style.color=s===100?"var(--text-primary)":"var(--warning)");const a=document.getElementById("weight-error");a&&(a.style.display=s===100?"none":"block")}function Gt(e){if(!e)return"0s";const t=Math.floor(e/(24*3600));e%=24*3600;const n=Math.floor(e/3600);e%=3600;const i=Math.floor(e/60),s=e%60;let o=[];return t>0&&o.push(`${t}d`),n>0&&o.push(`${n}h`),i>0&&o.push(`${i}m`),(s>0||o.length===0)&&o.push(`${s}s`),o.join(" ")}Object.assign(window,{switchTab:Z,switchScope:ot,control:ge,changeLibraryPage:fe,selectGuild:ve,leaveGuild:ae,leaveServer:re,saveServerSettings:be,saveSettingsTab:we,toggleNotifications:_e,viewUser:me,openGlobalSettings:pe,initCharts:jt,updateCharts:Nt})})();
